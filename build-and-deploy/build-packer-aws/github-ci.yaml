name: Build Go Binary and Packer AMI

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  go-packer-ami:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    env:
      AWS_REGION: eu-west-1
      BINARY_NAME: infradots

    steps:
      - name: Checkout Repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # v5.0.1

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c  # v6.1.0
        with:
          go-version: '1.23'

      - name: Build Go Binary
        run: |
          mkdir -p build
          go build -o build/${BINARY_NAME} ./cmd

      - name: Archive Binary
        run: tar -czf build/${BINARY_NAME}.tar.gz -C build ${BINARY_NAME}

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708  # v5.1.1
        with:
          role-to-assume: arn:aws:iam::YOUR_ACCOUNT_ID:role/YOUR_GITHUB_ROLE
          aws-region: ${{ env.AWS_REGION }}

      - name: Install HashiCorp Packer
        uses: hashicorp/setup-packer@1aa358be5cf73883762b302a3a03abd66e75b232  # v3.1.0
        with:
          version: 1.14.3

      - name: Validate Packer Template
        run: |
          packer init template.pkr.hcl
          packer validate -var "go_binary=build/${BINARY_NAME}" template.pkr.hcl

      - name: Build AMI with Packer
        id: build
        run: |
          packer build -var "go_binary=build/${BINARY_NAME}" -machine-readable template.pkr.hcl | tee output.log

      - name: Extract AMI ID from Output
        id: ami
        run: |
          AMI_ID=$(grep 'artifact,0,id' output.log | cut -d, -f6 | cut -d: -f2)
          echo "AMI_ID=$AMI_ID" >> "$GITHUB_OUTPUT"

      - name: Print AMI ID
        run: echo "Built AMI ID: ${{ steps.ami.outputs.AMI_ID }}"

      - name: Upload Packer Log
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        with:
          name: packer-log
          path: packer.log
